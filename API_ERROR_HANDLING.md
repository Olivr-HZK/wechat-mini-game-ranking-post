# API错误处理说明

## 常见HTTP状态码及处理方式

### 400 Bad Request
**含义：** 请求参数错误

**可能原因：**
- 关键词格式不正确
- 请求参数不符合API要求
- 某些特殊字符导致的问题

**处理方式：**
- 系统会自动跳过该关键词，继续搜索其他关键词
- 不会重试（因为参数错误重试也没用）

**建议：**
- 检查关键词是否包含特殊字符
- 如果某个关键词经常返回400，可以考虑移除或修改

### 401 Unauthorized
**含义：** 认证失败

**可能原因：**
- API Token无效或过期
- Token格式错误

**处理方式：**
- 系统会停止该关键词的搜索
- 不会重试（认证问题重试也没用）

**建议：**
- 检查 `.env` 文件中的 `DOUYIN_API_TOKEN` 是否正确
- 在TikHub网站重新生成API Token

### 429 Too Many Requests
**含义：** 请求频率过高

**可能原因：**
- 请求发送太快，超过了API的频率限制

**处理方式：**
- 系统会自动重试（最多3次）
- 每次重试前会等待更长时间（指数退避）
- 如果达到最大重试次数，跳过该关键词

**建议：**
- 增加 `API_REQUEST_DELAY` 配置值（默认1秒）
- 减少并发请求数量

### 500/502/503/504 服务器错误
**含义：** API服务器临时错误

**可能原因：**
- API服务器过载
- 服务器临时故障
- 网络问题

**处理方式：**
- 系统会自动重试（最多3次）
- 每次重试前会等待更长时间
- 如果达到最大重试次数，跳过该关键词

**建议：**
- 这些错误通常是临时的，重试可能会成功
- 如果频繁出现，可能是API服务不稳定

## 配置参数

在 `.env` 文件中可以配置以下参数：

```bash
# 请求间隔（秒），避免频率过高
API_REQUEST_DELAY=1.0

# 最大重试次数（针对502等临时错误）
API_MAX_RETRIES=3

# 重试延迟（秒）
API_RETRY_DELAY=2.0
```

### API_REQUEST_DELAY
- **默认值：** 1.0秒
- **作用：** 每个关键词搜索之间的等待时间
- **建议：** 如果遇到429错误，可以增加到2.0或3.0秒

### API_MAX_RETRIES
- **默认值：** 3次
- **作用：** 对于可重试的错误（502、503、504、429、超时），最多重试次数
- **建议：** 如果网络不稳定，可以增加到5次

### API_RETRY_DELAY
- **默认值：** 2.0秒
- **作用：** 重试前的等待时间（会按重试次数递增）
- **建议：** 如果API响应慢，可以增加到3.0或5.0秒

## 错误处理流程

```
发送请求
  ↓
收到响应
  ↓
判断状态码
  ├─ 200 → 成功，处理数据
  ├─ 400 → 参数错误，跳过该关键词
  ├─ 401 → 认证失败，跳过该关键词
  ├─ 429 → 频率过高，等待后重试
  ├─ 5xx → 服务器错误，等待后重试
  └─ 其他 → 记录错误，跳过该关键词
  ↓
如果可重试且未达到最大次数
  ↓
等待（延迟时间递增）
  ↓
重试
```

## 日志说明

系统会输出详细的错误信息：

- `✓` - 成功
- `✗` - 失败（不可重试）
- `⚠` - 警告（跳过该关键词）
- 重试时会显示：`等待 X 秒后重试 (1/3)...`

## 最佳实践

1. **设置合理的请求间隔**
   - 默认1秒通常足够
   - 如果遇到429错误，增加到2-3秒

2. **监控错误日志**
   - 如果某个关键词经常失败，考虑移除或修改
   - 如果所有关键词都失败，检查API Token

3. **网络稳定性**
   - 如果网络不稳定，增加重试次数和延迟
   - 考虑在网络稳定时运行

4. **API配额**
   - 注意API的调用次数限制
   - 如果达到配额，需要等待或升级账户