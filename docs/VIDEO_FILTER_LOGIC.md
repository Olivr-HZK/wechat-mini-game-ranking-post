# 视频筛选逻辑说明

## 筛选流程

### 1. 搜索阶段

**搜索关键词组合：**
- `{游戏名} 玩法`
- `{游戏名} 怎么玩`
- `{游戏名} 演示`
- `{游戏名} 玩法演示`

**API筛选条件：**
- `filter_duration: "0-1"` - 只搜索1分钟以内的视频
- `content_type: "1"` - 只搜索视频内容
- `sort_type: "1"` - 按最多点赞排序

### 2. 文本筛选阶段

对搜索结果进行二次筛选，确保内容相关性：

#### 2.1 排除不相关内容

如果视频标题/描述中**只包含**以下关键词，且**没有**相关关键词，则排除：
- 宣传、广告、推广
- 下载、安装、注册
- 充值、氪金、抽奖
- 活动、福利、奖励

#### 2.2 相关性评分

对每个视频计算相关性评分，评分越高越相关：

**基础分（10分）：**
- 包含游戏名称：+10分

**相关关键词加分（每个+5分，高优先级额外+3分）：**
- 玩法、演示、怎么玩、教程：+5分 + 3分（高优先级）
- 如何玩、操作、技巧、攻略、教学、展示、试玩、体验：+5分

**时长加分：**
- 15-60秒：+5分（最适合玩法演示）
- 10-15秒：+2分
- 超过60秒：-2分（可能不是纯玩法演示）

**热度加分：**
- 点赞数 > 1000：+2分
- 点赞数 > 100：+1分

### 3. 排序和选择

1. 按相关性评分从高到低排序
2. 去重（基于aweme_id）
3. 返回评分最高的视频

## 筛选逻辑示例

### 示例1：高相关性视频

**标题：** "羊了个羊玩法演示，3分钟教你通关！"

**评分计算：**
- 包含"羊了个羊"：+10分
- 包含"玩法"：+5分 + 3分（高优先级）= +8分
- 包含"演示"：+5分 + 3分（高优先级）= +8分
- 包含"教程"：+5分 + 3分（高优先级）= +8分
- 假设时长30秒：+5分
- 假设点赞500：+1分

**总分：** 10 + 8 + 8 + 8 + 5 + 1 = **40分**

### 示例2：低相关性视频（会被排除）

**标题：** "羊了个羊新活动，充值送福利！"

**检查：**
- 包含"活动"（不相关关键词）
- 包含"充值"（不相关关键词）
- 没有相关关键词（玩法、演示等）

**结果：** 被排除

### 示例3：中等相关性视频

**标题：** "跳一跳游戏，看看能跳多远"

**评分计算：**
- 包含"跳一跳"：+10分
- 没有明显的玩法/演示关键词：0分
- 假设时长20秒：+5分

**总分：** 10 + 5 = **15分**

## 为什么有些视频没下载？

在测试脚本中，**所有搜索到的视频都会保存到数据库**，但：

1. **测试脚本的下载逻辑**：
   - 旧版本：只下载每个游戏的第一个视频
   - 新版本：下载所有找到的视频（按相关性排序）

2. **数据库中的视频状态**：
   - `downloaded = 0`：已保存到数据库，但未下载
   - `downloaded = 1`：已下载到本地

3. **如何下载所有视频**：
   ```python
   from modules.database import VideoDatabase
   from modules.video_searcher import VideoSearcher
   
   db = VideoDatabase()
   searcher = VideoSearcher()
   
   # 获取所有未下载的视频
   all_videos = db.get_all_videos()
   for video in all_videos:
       if not video.get('downloaded'):
           searcher.download_video(video)
   ```

## 优化效果

### 优化前：
- 只通过关键词搜索，可能返回不相关视频
- 没有二次筛选，可能包含广告、宣传等内容
- 没有评分机制，无法判断视频质量

### 优化后：
- 多关键词组合搜索，提高覆盖率
- 文本筛选排除不相关内容
- 相关性评分确保最相关的视频排在前面
- 时长筛选确保视频适合玩法演示（15-60秒最佳）

## 调整筛选条件

如果需要调整筛选逻辑，可以修改 `modules/video_searcher.py` 中的 `_filter_and_score_videos` 方法：

1. **修改相关关键词**：调整 `relevant_keywords` 列表
2. **修改不相关关键词**：调整 `irrelevant_keywords` 列表
3. **调整评分权重**：修改各项加分的数值
4. **调整时长范围**：修改时长加分的条件